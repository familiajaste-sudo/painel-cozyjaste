<!--
Painel Familiar estilo Cozyla - arquivo único (HTML + CSS + JS)
INSTRUÇÕES: este arquivo integra o painel Cozyla original com o widget de Clima + Mapa (OpenWeatherMap + OpenStreetMap/Leaflet).

Salve como: painel_cozyla_integrado.html

O arquivo inclui:
- Google Calendar, Google Tasks, Google Keep (uso via APIs, OAuth placeholder CLIENT_ID existe)
- Clima em tempo real + previsão 3 dias para Belém (usa OpenWeatherMap - chave já colocada)
- Mapa interativo (OpenStreetMap via Leaflet)
- Layout responsivo estilo Cozyla/Cozyla-like

Substitua os placeholders CLIENT_ID e OPENWEATHER_API_KEY quando necessário.
-->

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Familiar — Cozyla Integrated</title>

  <!-- Leaflet (OpenStreetMap) para mapa -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    /* Reset simples */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:#222}
    body{background:#f6f8fb;display:flex;align-items:center;justify-content:center;padding:16px}

    /* Container principal */
    .dashboard{width:100%;max-width:1400px;height:90vh;background:rgba(255,255,255,0.95);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.08);display:grid;grid-template-columns:1fr 420px;grid-template-rows:auto 1fr;gap:16px;padding:18px}

    /* Header */
    .header{grid-column:1 / -1;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:14px}
    .brand .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,#ff9966,#ff5e62);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
    .brand h1{font-size:20px}
    .header .meta{display:flex;gap:12px;align-items:center}

    /* Main left (calendário e mapa) */
    .left-column{display:flex;flex-direction:column;gap:16px}
    .calendar-area{background:#fff;border-radius:10px;padding:14px;box-shadow:inset 0 -1px 0 rgba(0,0,0,0.02);overflow:auto;min-height:34vh}
    .month{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .month h2{font-size:18px}
    .events{display:flex;flex-direction:column;gap:8px}
    .event{padding:10px;border-radius:8px;background:linear-gradient(180deg,#fbfbff,#f4f7ff);box-shadow:0 1px 4px rgba(20,30,60,0.03)}

    /* Map area inside left column */
    .map-card{background:#fff;padding:0;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,60,0.03);overflow:hidden}
    #map{width:100%;height:320px}

    /* Right column */
    .right-col{display:flex;flex-direction:column;gap:12px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,60,0.03)}
    .card h3{font-size:15px;margin-bottom:8px}

    /* Tasks / Keep list styling */
    .tasks-list,.notes-list{display:flex;flex-direction:column;gap:8px;max-height:28vh;overflow:auto}
    .task-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:#fcfcff}
    .task-item input{width:18px;height:18px}

    /* Weather small */
    .weather{display:flex;align-items:center;gap:12px}
    .weather .big{font-size:28px;font-weight:600}

    /* Clock */
    .clock{font-size:22px;font-weight:700}

    /* Photos / footer */
    .photos{display:flex;gap:8px;overflow:auto}
    .photo{min-width:80px;height:60px;border-radius:8px;background-size:cover;background-position:center}

    /* Responsive */
    @media(max-width:1100px){
      .dashboard{grid-template-columns:1fr;grid-template-rows:auto auto 1fr}
    }

    /* Dark theme styles */
    .dark{background:#0f1724;color:#e6eef8}
    .dark .dashboard{background:linear-gradient(180deg,#0b1220,#071025);}
    .dark .card{background:rgba(255,255,255,0.03)}
    .theme-toggle{cursor:pointer;padding:6px 10px;border-radius:8px;background:#f1f5f9}
    .dark .theme-toggle{background:rgba(255,255,255,0.06)}

    /* Cozyla-like large cards */
    .calendar-area{min-height:40vh}
  </style>
</head>
<body>
  <div class="dashboard" id="dashboard">
    <div class="header">
      <div class="brand">
        <div class="logo">FJ</div>
        <div>
          <h1>Painel Familiar — Família Jaste</h1>
          <div style="font-size:13px;color:#667">Belém do Pará · Cozyla-like dashboard</div>
        </div>
      </div>

      <div class="meta">
        <div class="clock" id="clock">--:--</div>
        <div class="theme-toggle" id="themeToggle">Tema: Claro</div>
      </div>
    </div>

    <div class="left-column" style="grid-column:1 / 2">
      <section class="calendar-area card">
        <div class="month">
          <h2 id="monthTitle">Agenda — Hoje</h2>
          <div style="display:flex;gap:10px;align-items:center">
            <button id="signinBtn">Entrar com Google</button>
            <button id="signoutBtn" style="display:none">Sair</button>
          </div>
        </div>
        <div class="events" id="eventsList">
          <div style="color:#789">Carregando eventos...</div>
        </div>
      </section>

      <section class="map-card card">
        <div id="map"></div>
      </section>
    </div>

    <aside class="right-col">
      <section class="card">
        <h3>Tarefas (Google Tasks)</h3>
        <div class="tasks-list" id="tasksList">
          <div style="color:#789">Carregando tarefas...</div>
        </div>
      </section>

      <section class="card">
        <h3>Notas & Lista (Google Keep)</h3>
        <div class="notes-list" id="notesList">
          <div style="color:#789">Carregando notas...</div>
        </div>
      </section>

      <section class="card">
        <h3>Clima — Belém do Pará</h3>
        <div class="weather" id="weatherCard">
          <div>
            <div class="big" id="temp">--°C</div>
            <div id="desc">--</div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div id="hum">Hum: --%</div>
            <div id="wind">Vento: -- m/s</div>
          </div>
        </div>
      </section>

    </aside>

    <section style="grid-column:1 / -1;margin-top:6px">
      <div class="card">
        <h3>Fotos / Lembretes</h3>
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="photos" id="photosRow">
            <div class="photo" style="background-image:url('https://images.unsplash.com/photo-1504198453319-5ce911bafcde?auto=format&fit=crop&w=800&q=60')"></div>
            <div class="photo" style="background-image:url('https://images.unsplash.com/photo-1515488042420-6d7bfb2e4f16?auto=format&fit=crop&w=800&q=60')"></div>
            <div class="photo" style="background-image:url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=800&q=60')"></div>
          </div>
          <div style="margin-left:16px;color:#556">Frase do dia: <span id="dailyQuote">Faça uma boa ação hoje.</span></div>
        </div>
      </div>
    </section>

  </div>

  <script>
    /***** CONFIGURAÇÕES - SUBSTITUA AQUI *****/
    const CLIENT_ID = 'REPLACE_WITH_YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com';
    const API_KEY = ''; // opcional
    const OPENWEATHER_API_KEY = 'bed39eecfc308f209f24c123e9d963d7';
    const DEFAULT_LOCATION = { name: 'Belém, BR', lat: -1.455833, lon: -48.504444 };
    const OAUTH_SCOPES = [
      'https://www.googleapis.com/auth/calendar.readonly',
      'https://www.googleapis.com/auth/tasks.readonly',
      'https://www.googleapis.com/auth/keep.readonly'
    ];
    /******************************************/

    // Temas
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    let dark = false;
    themeToggle.addEventListener('click', ()=>{dark=!dark;body.classList.toggle('dark',dark);themeToggle.textContent = 'Tema: ' + (dark? 'Escuro':'Claro')});

    // Relógio
    function updateClock(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      document.getElementById('clock').textContent = hh+':'+mm;
    }
    setInterval(updateClock,1000); updateClock();

    // Google API client loader
    function loadGapi(){
      const s = document.createElement('script');
      s.src = 'https://apis.google.com/js/api.js';
      s.onload = ()=>gapi.load('client:auth2', initClient);
      document.head.appendChild(s);
    }

    async function initClient(){
      try{
        await gapi.client.init({
          apiKey: API_KEY || undefined,
          clientId: CLIENT_ID,
          discoveryDocs: [
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            'https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest',
          ],
          scope: OAUTH_SCOPES.join(' ')
        });

        const authInstance = gapi.auth2.getAuthInstance();
        const signinBtn = document.getElementById('signinBtn');
        const signoutBtn = document.getElementById('signoutBtn');

        signinBtn.addEventListener('click', ()=>authInstance.signIn());
        signoutBtn.addEventListener('click', ()=>authInstance.signOut());

        authInstance.isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(authInstance.isSignedIn.get());

      }catch(e){console.error('Erro initClient',e)}
    }

    async function updateSigninStatus(isSignedIn){
      const signinBtn = document.getElementById('signinBtn');
      const signoutBtn = document.getElementById('signoutBtn');
      if(isSignedIn){
        signinBtn.style.display='none';signoutBtn.style.display='inline-block';
        const user = gapi.auth2.getAuthInstance().currentUser.get();
        const profile = user.getBasicProfile();
        console.log('Usuário:',profile.getEmail());
        fetchAndRenderAll();
      }else{
        signinBtn.style.display='inline-block';signoutBtn.style.display='none';
      }
    }

    // Fetch Calendar events (próximas 24 horas)
    async function fetchCalendarEvents(){
      try{
        const now = new Date();
        const end = new Date(); end.setDate(now.getDate()+1);
        const response = await gapi.client.calendar.events.list({
          'calendarId':'primary',
          'timeMin': now.toISOString(),
          'timeMax': end.toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'orderBy':'startTime'
        });
        return response.result.items || [];
      }catch(e){console.error('Erro Calendar',e);return []}
    }

    function renderEvents(events){
      const container = document.getElementById('eventsList');
      container.innerHTML = '';
      if(!events.length) { container.innerHTML = '<div style="color:#789">Sem eventos para as próximas 24h</div>'; return }
      events.forEach(ev=>{
        const div = document.createElement('div'); div.className='event';
        const start = ev.start.dateTime || ev.start.date; const d = new Date(start);
        const timeStr = ev.start.dateTime ? d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : 'Dia todo';
        div.innerHTML = `<div style="font-weight:600">${ev.summary||'(Sem título)'}</div><div class="time">${timeStr} · ${ev.location||''}</div>`;
        container.appendChild(div);
      })
    }

    // Fetch Tasks (Google Tasks API)
    async function fetchTasks(){
      try{
        const lists = await gapi.client.tasks.tasklists.list({maxResults:20});
        const taskItems = [];
        if(lists.result.items && lists.result.items.length){
          for(const tl of lists.result.items){
            const res = await gapi.client.tasks.tasks.list({tasklist: tl.id, maxResults: 30});
            if(res.result.items) taskItems.push(...res.result.items.map(t=>({...t, listTitle: tl.title}))); 
          }
        }
        return taskItems;
      }catch(e){console.error('Erro Tasks',e);return []}
    }

    function renderTasks(tasks){
      const container = document.getElementById('tasksList'); container.innerHTML='';
      if(!tasks.length){container.innerHTML='<div style="color:#789">Sem tarefas</div>';return}
      tasks.slice(0,20).forEach(t=>{
        const div = document.createElement('div'); div.className='task-item';
        const chk = document.createElement('input'); chk.type='checkbox'; chk.disabled=true; chk.checked = !!t.status && t.status!=='needsAction' ? true:false;
        div.appendChild(chk);
        const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:600">${t.title}</div><div style="font-size:12px;color:#667">${t.listTitle || ''}</div>`;
        div.appendChild(txt);
        container.appendChild(div);
      })
    }

    // Fetch Google Keep notes - no discovery doc in gapi, use REST
    async function fetchKeepNotes(){
      try{
        const token = gapi.auth.getToken().access_token;
        const resp = await fetch('https://keep.googleapis.com/v1/notes?pageSize=20', {headers:{Authorization:'Bearer '+token}});
        if(!resp.ok) throw new Error('Keep API error');
        const data = await resp.json();
        return data.notes || [];
      }catch(e){console.warn('Keep fetch error',e);return []}
    }

    function renderKeep(notes){
      const container = document.getElementById('notesList'); container.innerHTML='';
      if(!notes.length){container.innerHTML='<div style="color:#789">Sem notas</div>';return}
      notes.slice(0,20).forEach(n =>{
        const div = document.createElement('div'); div.className='task-item';
        const title = n.title || (n.textContent && n.textContent[0] && n.textContent[0].text) || 'Nota';
        const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:600">${title}</div><div style="font-size:12px;color:#667">${n.labels ? n.labels.join(', '):''}</div>`;
        div.appendChild(txt);
        container.appendChild(div);
      })
    }

    // Weather using OpenWeatherMap (agora integrado)
    async function fetchWeather(){
      try{
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${DEFAULT_LOCATION.lat}&lon=${DEFAULT_LOCATION.lon}&units=metric&lang=pt_br&appid=${OPENWEATHER_API_KEY}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('Weather fetch failed');
        const j = await r.json();
        return j;
      }catch(e){console.warn('Weather error',e);return null}
    }

    async function fetchForecast(){
      try{
        const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${DEFAULT_LOCATION.lat}&lon=${DEFAULT_LOCATION.lon}&units=metric&lang=pt_br&appid=${OPENWEATHER_API_KEY}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('Forecast fetch failed');
        const j = await r.json();
        return j;
      }catch(e){console.warn('Forecast error',e);return null}
    }

    function renderWeatherToCard(w){
      if(!w) return; document.getElementById('temp').textContent = Math.round(w.main.temp)+'°C';
      document.getElementById('desc').textContent = w.weather && w.weather[0] ? w.weather[0].description : '';
      document.getElementById('hum').textContent = 'Hum: '+w.main.humidity+'%';
      document.getElementById('wind').textContent = 'Vento: '+(w.wind.speed || 0)+' m/s';
    }

    function renderForecastToSection(forecast){
      if(!forecast || !forecast.list) return;
      const container = document.getElementById('photosRow'); // reutilizando para mostrar cards de previsão abaixo como mini-fotos
      // vamos mostrar 3 cartões simplificados no final do painel
      container.innerHTML='';
      const daily = forecast.list.filter((it,idx)=> idx%8===0).slice(1,4);
      daily.forEach(it=>{
        const date = new Date(it.dt*1000);
        const title = date.toLocaleDateString('pt-BR',{weekday:'short'});
        const icon = it.weather[0].icon;
        const min = Math.round(it.main.temp_min);
        const max = Math.round(it.main.temp_max);
        const div = document.createElement('div');
        div.className='photo';
        div.style.backgroundImage = `url(https://openweathermap.org/img/wn/${icon}@2x.png)`;
        div.title = `${title}: ${min}° / ${max}°`;
        container.appendChild(div);
      });
    }

    // Map initialization (Leaflet)
    const map = L.map('map', { zoomControl: true, scrollWheelZoom: false }).setView([DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lon], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '© OpenStreetMap contributors' }).addTo(map);
    const marker = L.marker([DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lon]).addTo(map).bindPopup('<b>Belém - PA</b><br>Localização do painel.').openPopup();

    // Carrega tudo
    async function fetchAndRenderAll(){
      document.getElementById('eventsList').innerHTML = '<div style="color:#789">Carregando eventos...</div>';
      document.getElementById('tasksList').innerHTML = '<div style="color:#789">Carregando tarefas...</div>';
      document.getElementById('notesList').innerHTML = '<div style="color:#789">Carregando notas...</div>';

      const [events,tasks,notes,weather,forecast] = await Promise.all([
        fetchCalendarEvents(),
        fetchTasks(),
        fetchKeepNotes(),
        fetchWeather(),
        fetchForecast()
      ]);

      renderEvents(events);
      renderTasks(tasks);
      renderKeep(notes);
      if(weather) renderWeatherToCard(weather);
      if(forecast) renderForecastToSection(forecast);
    }

    // Inicialização GAPI
    function loadGapi(){
      const s = document.createElement('script');
      s.src = 'https://apis.google.com/js/api.js';
      s.onload = ()=>gapi.load('client:auth2', initClient);
      document.head.appendChild(s);
    }
    loadGapi();

    // Auto refresh a cada 5 minutos
    setInterval(()=>{if(window.gapi && gapi.auth2 && gapi.auth2.getAuthInstance && gapi.auth2.getAuthInstance().isSignedIn.get()) fetchAndRenderAll();},5*60*1000);

    // Mensagem para instruções rápidas
    console.log('Painel integrado iniciado. Substitua CLIENT_ID se quiser login Google; OPENWEATHER_API_KEY já foi preenchida.');

    // Inicial fetch de clima mesmo sem login
    (async ()=>{
      const w = await fetchWeather(); if(w) renderWeatherToCard(w);
      const f = await fetchForecast(); if(f) renderForecastToSection(f);
    })();

  </script>

</body>
</html>
