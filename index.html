<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Cozyla — Calendário OAuth • Clima & Mapa</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

  <!-- Leaflet (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root { --accent:#4f46e5; --muted:#6b7280; --bg:#f6f8fb }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#071022}
    .container{max-width:1200px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--accent),#6366f1);color:#fff;padding:12px;border-radius:10px}
    header h1{font-size:18px;margin:0}
    .main{display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:16px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,60,0.03)}
    #calendar { max-width:100%; min-height:520px; border-radius:8px; overflow:hidden }
    #map{height:300px;border-radius:8px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .btn.secondary{background:#10b981}
    select{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    .small{font-size:13px;color:var(--muted)}
    footer{margin-top:12px;text-align:center;color:var(--muted)}
    @media(max-width:1000px){ .main{grid-template-columns:1fr} #calendar {min-height:420px} #map{height:220px} }
    /* Cozyla-ish small touches */
    .brand {display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#ff9966,#ff5e62);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">FJ</div>
        <div>
          <h1>Painel Cozyla — Família Jaste</h1>
          <div class="small">Belém, PA · Integrado</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <div class="small" id="signedAs">Não conectado</div>
        <button id="signinBtn" class="btn">Conectar com Google</button>
        <button id="signoutBtn" class="btn" style="background:#ef4444;display:none">Sair</button>
      </div>
    </header>

    <div class="main">
      <!-- coluna esquerda: calendário -->
      <div class="card">
        <div class="controls">
          <label class="small">Calendário:</label>
          <select id="calendarSelect"><option>Conecte-se para listar</option></select>
          <button id="refreshCal" class="btn secondary">Atualizar</button>
        </div>

        <div id="calendar"></div>
      </div>

      <!-- coluna direita: mapa + clima -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="card">
          <div style="font-weight:700">Mapa</div>
          <div id="map" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div style="font-weight:700">Clima — Belém (OpenWeatherMap)</div>
          <div id="weatherBox" style="margin-top:8px">
            <div id="temp" style="font-size:28px;font-weight:800">--°C</div>
            <div id="desc" class="small">—</div>
            <div id="hum" class="small">—</div>
          </div>
        </div>
      </div>
    </div>

    <footer>Desenvolvido por Cozyla © 2025</footer>
  </div>

  <!-- gapi -->
  <script src="https://apis.google.com/js/api.js"></script>

  <script>
  /**********************************************
   * CONFIGURAÇÕES (substitua se necessário)
   **********************************************/
  const CLIENT_ID = "318293822293-lun70v10qr1dpll4ntaau8hgp1bldaql.apps.googleusercontent.com";    
  const API_KEY = ""; // opcional
  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
  const SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events.readonly";
  const OPENWEATHER_API_KEY = "bed39eecfc308f209f24c123e9d963d7";
  const CITY_COORDS = { lat: -1.455833, lon: -48.504444 }; // Belém
  /**********************************************/

  // UI
  const signinBtn = document.getElementById('signinBtn');
  const signoutBtn = document.getElementById('signoutBtn');
  const signedAs = document.getElementById('signedAs');
  const calendarSelect = document.getElementById('calendarSelect');
  const refreshCal = document.getElementById('refreshCal');

  // FullCalendar
  const calendarEl = document.getElementById('calendar');
  const fc = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    nowIndicator: true,
    events: []
  });
  fc.render();

  // Map (Leaflet)
  const map = L.map('map', { scrollWheelZoom: false }).setView([CITY_COORDS.lat, CITY_COORDS.lon], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
  L.marker([CITY_COORDS.lat, CITY_COORDS.lon]).addTo(map).bindPopup('Belém - PA').openPopup();

  // OpenWeather
  async function loadWeather() {
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${CITY_COORDS.lat}&lon=${CITY_COORDS.lon}&units=metric&lang=pt_br&appid=${OPENWEATHER_API_KEY}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('Erro clima: ' + r.status);
      const j = await r.json();
      document.getElementById('temp').textContent = Math.round(j.main.temp) + '°C';
      document.getElementById('desc').textContent = j.weather[0].description;
      document.getElementById('hum').textContent = 'Umidade: ' + j.main.humidity + '%';
    } catch (e) {
      console.error(e);
      document.getElementById('desc').textContent = 'Erro ao carregar clima';
    }
  }
  loadWeather();

  /* ---------- Google API (gapi) ---------- */
  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }

  async function initClient() {
    try {
      await gapi.client.init({
        apiKey: API_KEY || undefined,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      });

      const auth = gapi.auth2.getAuthInstance();
      auth.isSignedIn.listen(updateSigninStatus);
      updateSigninStatus(auth.isSignedIn.get());

      signinBtn.addEventListener('click', () => auth.signIn());
      signoutBtn.addEventListener('click', () => auth.signOut());
    } catch (err) {
      console.error('initClient error', err);
    }
  }

  async function updateSigninStatus(isSignedIn) {
    const auth = gapi.auth2.getAuthInstance();
    if (isSignedIn) {
      const user = auth.currentUser.get();
      const profile = user.getBasicProfile();
      signedAs.textContent = profile.getEmail();
      signinBtn.style.display = 'none';
      signoutBtn.style.display = 'inline-block';
      await loadCalendarList();
      const saved = localStorage.getItem('cozyla_selected_calendar');
      if (saved) calendarSelect.value = saved;
      await loadEventsForSelectedCalendar();
    } else {
      signedAs.textContent = 'Não conectado';
      signinBtn.style.display = 'inline-block';
      signoutBtn.style.display = 'none';
      fc.removeAllEvents();
      calendarSelect.innerHTML = '<option>Conecte-se para ver calendários</option>';
    }
  }

  async function loadCalendarList() {
    try {
      const res = await gapi.client.calendar.calendarList.list({ maxResults: 250 });
      const items = res.result.items || [];
      calendarSelect.innerHTML = '';
      items.forEach(cal => {
        const opt = document.createElement('option');
        opt.value = cal.id;
        opt.textContent = cal.summary + (cal.primary ? ' (principal)' : '');
        calendarSelect.appendChild(opt);
      });
      if (!items.length) calendarSelect.innerHTML = '<option>(nenhum calendário encontrado)</option>';
      calendarSelect.addEventListener('change', async () => {
        localStorage.setItem('cozyla_selected_calendar', calendarSelect.value);
        await loadEventsForSelectedCalendar();
      });
    } catch (e) {
      console.error('Erro listar calendários', e);
      calendarSelect.innerHTML = '<option>Erro ao listar calendários</option>';
    }
  }

  async function loadEventsForSelectedCalendar() {
    const calId = calendarSelect.value;
    if (!calId) return;
    fc.removeAllEvents();
    fc.addEvent({ title: 'Carregando...', start: new Date() });

    try {
      const now = new Date();
      const timeMin = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
      const timeMax = new Date(now.getFullYear(), now.getMonth() + 2, 0).toISOString();

      const res = await gapi.client.calendar.events.list({
        calendarId: calId,
        singleEvents: true,
        orderBy: 'startTime',
        timeMin,
        timeMax,
        maxResults: 250
      });

      const items = res.result.items || [];
      fc.removeAllEvents();

      const fcEvents = items.map(ev => {
        const start = ev.start.dateTime || ev.start.date;
        const end = ev.end ? (ev.end.dateTime || ev.end.date) : null;
        return {
          id: ev.id,
          title: ev.summary || '(Sem título)',
          start,
          end,
          allDay: !!ev.start.date && !ev.start.dateTime,
          extendedProps: { location: ev.location || '', description: ev.description || '' }
        };
      });

      fc.addEventSource(fcEvents);
    } catch (e) {
      console.error('Erro buscar eventos', e);
      fc.removeAllEvents();
      fc.addEvent({ title: 'Erro ao carregar eventos', start: new Date() });
    }
  }

  // refresh button
  refreshCal.addEventListener('click', async () => {
    await loadCalendarList();
    await loadEventsForSelectedCalendar();
  });

  // carrega gapi no final
  handleClientLoad();
  </script>
</body>
</html>
